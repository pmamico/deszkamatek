<!DOCTYPE html>
<html lang="hu" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deszkamatek - Padló Tervező</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        #canvas-container {
            margin-top: 20px;
            text-align: center;
        }
        canvas {
            border: 1px solid #ddd;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            margin: 0 10px;
        }
        label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100px;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            align-self: flex-end;
        }
        button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="text-align: center; margin-bottom: 20px;" class="nav-links">
            <a href="/" style="font-weight: bold;">Szoba Megjelenítő</a> | 
            <a href="/raktar" style="color: #4CAF50; text-decoration: none;">Raktár kezelése</a>
            <div style="color: #999999; font-size: 12px; margin-top: 5px;" th:if="${buildTime}">
                Build: <span th:text="${buildTime}">2023-01-01 00:00:00</span>
            </div>
        </div>
        <h1>Padló Tervező</h1>
        <div class="controls">
            <div class="input-group">
                <label for="x-input">Szélesség (X):</label>
                <input type="number" id="x-input" value="460" min="10" max="1000">
            </div>
            <div class="input-group">
                <label for="y-input">Magasság (Y):</label>
                <input type="number" id="y-input" value="397" min="10" max="1000">
            </div>
            <div class="input-group">
                <label for="dilatacio-input">Dilatáció (cm):</label>
                <input type="number" id="dilatacio-input" value="1.5" min="0" max="10" step="0.1">
            </div>
            <button id="calculate-btn">Újraszámolás</button>
            <button id="reset-btn">Visszaállítás</button>
        </div>

        <div id="canvas-container">
            <canvas id="szoba-canvas" width="800" height="800"></canvas>
        </div>

        <!-- Jelmagyarázat -->
        <div class="legend" style="margin: 20px 0; padding: 10px; background-color: #f0f0f0; border-radius: 5px; display: flex; justify-content: center;">
            <div style="margin: 0 15px; display: flex; align-items: center;">
                <div style="width: 20px; height: 20px; border-radius: 50%; background-color: blue; margin-right: 5px;"></div>
                <span>C - Csap</span>
            </div>
            <div style="margin: 0 15px; display: flex; align-items: center;">
                <div style="width: 20px; height: 20px; border-radius: 50%; background-color: green; margin-right: 5px;"></div>
                <span>N - Nút</span>
            </div>
            <div style="margin: 0 15px; display: flex; align-items: center;">
                <div style="width: 20px; height: 20px; border-radius: 50%; background-color: red; margin-right: 5px;"></div>
                <span>V - Vágás</span>
            </div>
        </div>

        <!-- Statisztikák -->
        <div id="statistics" class="statistics" style="margin: 20px 0; padding: 10px; background-color: #f0f0f0; border-radius: 5px;">
            <h3 style="margin-top: 0; text-align: center;">Statisztikák</h3>
            <div style="display: flex; justify-content: space-around; flex-wrap: wrap;">
                <div style="margin: 5px 10px;">
                    <strong>Vágások száma:</strong> <span id="cuts-count">0</span>
                </div>
                <div style="margin: 5px 10px;">
                    <strong>Felhasznált deszkák száma:</strong> <span id="boards-count">0</span>
                </div>
                <div style="margin: 5px 10px;">
                    <strong>Vásárolt m²:</strong> <span id="boards-area">0</span> m²
                </div>
                <div style="margin: 5px 10px;">
                    <strong>Burkolt felület:</strong> <span id="covered-area">0</span> m²
                </div>
            </div>
        </div>
    </div>

    <!-- Fabric.js könyvtár betöltése CDN-ről -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

    <script>
        // Fabric.js canvas inicializálása
        const canvas = new fabric.Canvas('szoba-canvas');

        // Oldalállapot jelölő létrehozása
        function createSideMarker(x, y, side, allapot) {
            let marker;
            const size = 15;
            let color;
            let text;

            // Állapot szerinti színezés és szöveg
            const allapotStr = typeof allapot === 'string' ? allapot : allapot.toString();

            if (allapotStr.includes('CSAP')) {
                color = 'blue';
                text = 'C';
            } else if (allapotStr.includes('NUT')) {
                color = 'green';
                text = 'N';
            } else if (allapotStr.includes('VAGOTT')) {
                color = 'red';
                text = 'V';
            } else {
                color = 'gray';
                text = '?';
            }

            // Oldal szerinti pozícionálás
            let left = x;
            let top = y;
            let originX = 'center';
            let originY = 'center';

            switch(side) {
                case 'left':
                    left -= size/2;
                    originX = 'right';
                    break;
                case 'right':
                    left += size/2;
                    originX = 'left';
                    break;
                case 'top':
                    top -= size/2;
                    originY = 'bottom';
                    break;
                case 'bottom':
                    top += size/2;
                    originY = 'top';
                    break;
            }

            // Marker létrehozása (kör alakú háttér szöveggel)
            const circle = new fabric.Circle({
                left: left,
                top: top,
                radius: size/2,
                fill: color,
                stroke: 'black',
                strokeWidth: 1,
                originX: originX,
                originY: originY
            });

            const label = new fabric.Text(text, {
                left: left,
                top: top,
                fontSize: 10,
                fill: 'white',
                fontWeight: 'bold',
                originX: originX,
                originY: originY
            });

            // Csoportba foglalás
            marker = new fabric.Group([circle, label], {
                left: left,
                top: top,
                originX: originX,
                originY: originY,
                selectable: false
            });

            return marker;
        }

        // Kezdeti szoba adatok lekérése a szerverről
        fetchSzobaData();

        // Újraszámolás gomb eseménykezelő
        document.getElementById('calculate-btn').addEventListener('click', function() {
            fetchSzobaData();
        });

        // Visszaállítás gomb eseménykezelő
        document.getElementById('reset-btn').addEventListener('click', function() {
            // Eredeti paraméterek visszaállítása
            document.getElementById('x-input').value = 460;
            document.getElementById('y-input').value = 397;
            document.getElementById('dilatacio-input').value = 1.5;

            // Újraszámolás az eredeti paraméterekkel
            fetchSzobaData();
        });

        // Szoba adatok lekérése a szerverről
        function fetchSzobaData() {
            const xInput = document.getElementById('x-input');
            const yInput = document.getElementById('y-input');
            const dilatacioInput = document.getElementById('dilatacio-input');

            const x = xInput.value;
            const y = yInput.value;
            const dilatacio = dilatacioInput.value;

            // Tisztítjuk a canvas-t új adatok betöltése előtt
            canvas.clear();

            fetch(`/api/epito?x=${x}&y=${y}&dilatacio=${dilatacio}`)
                .then(response => response.json())
                .then(data => {
                    renderSzoba(data);
                    updateStatistics(data);
                })
                .catch(error => console.error('Hiba történt:', error));
        }

        // Statisztikák frissítése
        function updateStatistics(data) {
            console.log("Updating statistics with data:", JSON.stringify(data));

            // Check if data exists
            if (!data) {
                console.error("No data received");
                return;
            }

            // Check if lerakottDeszkak exists and has items
            if (data.lerakottDeszkak) {
                console.log("Placed boards count:", data.lerakottDeszkak.length);
            } else {
                console.error("No placed boards data found");
            }

            // Check if statistics data exists
            if (data.statisztikak) {
                console.log("Statistics data:", JSON.stringify(data.statisztikak));

                // Update UI with statistics data
                document.getElementById('cuts-count').textContent = data.statisztikak.vagasokSzama || 0;
                document.getElementById('boards-count').textContent = data.statisztikak.deszkakSzama || 0;
                document.getElementById('boards-area').textContent = (data.statisztikak.deszkakTeruletM2 || 0).toFixed(2);
                document.getElementById('covered-area').textContent = (data.statisztikak.burkoltFeluletM2 || 0).toFixed(2);
            } else {
                console.error("No statistics data found in the response");

                // If no statistics data but we have placed boards, calculate statistics manually
                if (data.lerakottDeszkak && data.lerakottDeszkak.length > 0) {
                    console.log("Calculating statistics manually from placed boards");

                    // Set boards count
                    const boardsCount = data.lerakottDeszkak.length;
                    document.getElementById('boards-count').textContent = boardsCount;

                    // Calculate and set board area
                    let totalAreaCm2 = 0;
                    data.lerakottDeszkak.forEach(board => {
                        if (board.deszka) {
                            totalAreaCm2 += board.deszka.szelesseg * board.deszka.hosszusag;
                        }
                    });
                    const totalAreaM2 = totalAreaCm2 / 10000;
                    document.getElementById('boards-area').textContent = totalAreaM2.toFixed(2);

                    // Calculate and set covered area if we have room dimensions
                    if (data.szoba) {
                        const width = data.szoba.x - 2 * data.szoba.dilatacio;
                        const height = data.szoba.y - 2 * data.szoba.dilatacio;
                        const coveredAreaM2 = (width * height) / 10000;
                        document.getElementById('covered-area').textContent = coveredAreaM2.toFixed(2);
                    }
                }
            }
        }

        // Szoba és deszkák megjelenítése
        function renderSzoba(data) {
            const szoba = data.szoba;
            const lerakottDeszkak = data.lerakottDeszkak;

            // Canvas méretezése a szoba méretéhez
            const canvasWidth = 800;
            const canvasHeight = 800;
            const padding = 50;
            const topPadding = 100; // Extra padding at the top for tooltips

            // Skálázási faktor kiszámítása, hogy a szoba elférjen a canvas-en
            const scaleX = (canvasWidth - 2 * padding) / szoba.x;
            const scaleY = (canvasHeight - topPadding - padding) / szoba.y;
            const scale = Math.min(scaleX, scaleY);

            // Szoba háttér (halványszürke téglalap)
            const szobaRect = new fabric.Rect({
                left: padding,
                top: topPadding,
                width: szoba.x * scale,
                height: szoba.y * scale,
                fill: '#e0e0e0',
                stroke: '#999',
                strokeWidth: 1,
                selectable: false,
                hoverCursor: 'default'
            });
            canvas.add(szobaRect);

            // X tengely hosszának megjelenítése
            const xAxisLabel = new fabric.Text(
                `X tengely: ${szoba.x} cm`, 
                {
                    left: padding + (szoba.x * scale) / 2,
                    top: topPadding + szoba.y * scale + 30,
                    fontSize: 14,
                    fill: 'black',
                    originX: 'center',
                    selectable: false
                }
            );
            canvas.add(xAxisLabel);

            // Y tengely hosszának megjelenítése
            const yAxisLabel = new fabric.Text(
                `Y tengely: ${szoba.y} cm`, 
                {
                    left: padding - 20,
                    top: topPadding + (szoba.y * scale) / 2,
                    fontSize: 14,
                    fill: 'black',
                    originY: 'center',
                    angle: -90,
                    selectable: false
                }
            );
            canvas.add(yAxisLabel);

            // Dilatáció értékének megjelenítése
            const dilatacioLabel = new fabric.Text(
                `Dilatáció: ${szoba.dilatacio} cm`, 
                {
                    left: padding + (szoba.x * scale) / 2,
                    top: topPadding + szoba.y * scale + 60,
                    fontSize: 14,
                    fill: 'black',
                    originX: 'center',
                    selectable: false
                }
            );
            canvas.add(dilatacioLabel);

            // Dilatáció vizuális megjelenítése (belső téglalap)
            const dilatacioRect = new fabric.Rect({
                left: padding + szoba.dilatacio * scale,
                top: topPadding + szoba.dilatacio * scale,
                width: (szoba.x - 2 * szoba.dilatacio) * scale,
                height: (szoba.y - 2 * szoba.dilatacio) * scale,
                fill: 'transparent',
                stroke: '#ff0000',
                strokeWidth: 1,
                strokeDashArray: [5, 5],
                selectable: false,
                hoverCursor: 'default'
            });
            canvas.add(dilatacioRect);

            // Ajtó rajzolása a jobb alsó sarokban
            const doorWidth = 60 * scale;
            const doorHeight = 10 * scale;
            const doorX = padding + szoba.x * scale - doorWidth; // Jobb oldal
            const doorY = topPadding + szoba.y * scale - doorHeight; // Alsó rész

            // Ajtó téglalap
            const doorRect = new fabric.Rect({
                left: doorX,
                top: doorY,
                width: doorWidth,
                height: doorHeight,
                fill: 'white',
                stroke: 'black',
                strokeWidth: 2,
                selectable: false
            });

            // Ajtó nyitási ív
            const doorArc = new fabric.Path('M 0 0 A 60 60 0 0 1 60 60', {
                left: doorX,
                top: doorY,
                stroke: 'black',
                strokeWidth: 1,
                fill: 'transparent',
                scaleX: doorWidth / 60,
                scaleY: doorHeight / 60,
                selectable: false
            });

            // Ajtó felirat
            const doorLabel = new fabric.Text('Ajtó', {
                left: doorX + doorWidth / 2,
                top: doorY - 10,
                fontSize: 12,
                fill: 'black',
                originX: 'center',
                selectable: false
            });

            canvas.add(doorRect);
            canvas.add(doorArc);
            canvas.add(doorLabel);

            // Deszkák kirajzolása
            lerakottDeszkak.forEach(deszka => {
                const x = deszka.poz.x * scale + padding;
                const y = topPadding + (szoba.y - deszka.poz.y) * scale;
                const width = deszka.deszka.szelesseg * scale;
                const height = deszka.deszka.hosszusag * scale;

                const deszkaRect = new fabric.Rect({
                    left: x,
                    top: y,
                    width: width,
                    height: height,
                    fill: '#8B4513',  // Barna szín a deszkáknak
                    stroke: '#5D2906',
                    strokeWidth: 1,
                    selectable: false,
                    opacity: 0.8
                });

                canvas.add(deszkaRect);

                // Deszka információk hozzáadása tooltip-ként
                deszkaRect.on('mouseover', function() {
                    this.set('opacity', 1);

                    // Tooltip létrehozása a deszka méreteihez és oldalállapotaihoz
                    const tooltip = new fabric.Text(
                        `#${deszka.sorszam}\nSzélesség: ${deszka.deszka.szelesseg} cm\nHosszúság: ${deszka.deszka.hosszusag} cm`, 
                        {
                            left: x + width / 2,
                            top: y - 30,
                            fontSize: 14,
                            fill: 'black',
                            backgroundColor: 'rgba(255,255,255,0.9)',
                            padding: 5,
                            originX: 'center',
                            originY: 'bottom',
                            shadow: new fabric.Shadow({
                                color: 'rgba(0,0,0,0.3)',
                                blur: 5,
                                offsetX: 2,
                                offsetY: 2
                            })
                        }
                    );

                    // Oldalállapotok jelölése
                    const sideMarkers = [];

                    // Bal oldal (CSAP/NUT/VAGOTT)
                    if (deszka.deszka.balOldal) {
                        const balMarker = createSideMarker(x, y + height/2, 'left', deszka.deszka.balOldal);
                        sideMarkers.push(balMarker);
                    }

                    // Felső oldal (CSAP/NUT/VAGOTT)
                    if (deszka.deszka.felsoOldal) {
                        const felsoMarker = createSideMarker(x + width/2, y, 'top', deszka.deszka.felsoOldal);
                        sideMarkers.push(felsoMarker);
                    }

                    // Jobb oldal (CSAP/NUT/VAGOTT)
                    if (deszka.deszka.jobbOldal) {
                        const jobbMarker = createSideMarker(x + width, y + height/2, 'right', deszka.deszka.jobbOldal);
                        sideMarkers.push(jobbMarker);
                    }

                    // Alsó oldal (CSAP/NUT/VAGOTT)
                    if (deszka.deszka.alsoOldal) {
                        const alsoMarker = createSideMarker(x + width/2, y + height, 'bottom', deszka.deszka.alsoOldal);
                        sideMarkers.push(alsoMarker);
                    }

                    // Tooltip és jelölők hozzáadása a canvas-hez
                    canvas.add(tooltip);
                    tooltip.bringToFront(); // Ensure tooltip is on top

                    sideMarkers.forEach(marker => {
                        canvas.add(marker);
                        marker.bringToFront(); // Ensure markers are on top
                    });

                    // Tooltip és jelölők tárolása a deszkaRect objektumban
                    this.tooltip = tooltip;
                    this.sideMarkers = sideMarkers;

                    canvas.renderAll();
                });

                deszkaRect.on('mouseout', function() {
                    this.set('opacity', 0.8);

                    // Tooltip és jelölők eltávolítása
                    if (this.tooltip) {
                        canvas.remove(this.tooltip);
                        this.tooltip = null;
                    }

                    if (this.sideMarkers) {
                        this.sideMarkers.forEach(marker => canvas.remove(marker));
                        this.sideMarkers = [];
                    }

                    canvas.renderAll();
                });
            });

            // Távolságmérés az üres területekhez
            const boardRects = [];
            lerakottDeszkak.forEach(deszka => {
                const x = deszka.poz.x * scale + padding;
                const y = topPadding + (szoba.y - deszka.poz.y) * scale;
                const width = deszka.deszka.szelesseg * scale;
                const height = deszka.deszka.hosszusag * scale;

                boardRects.push({
                    left: x,
                    top: y,
                    right: x + width,
                    bottom: y + height,
                    width: width,
                    height: height,
                    realWidth: deszka.deszka.szelesseg,
                    realHeight: deszka.deszka.hosszusag
                });
            });

            // Távolságmérés tooltip
            let distanceTooltip = null;

            // Egér mozgás eseménykezelő a szobában
            canvas.on('mouse:move', function(options) {
                const pointer = canvas.getPointer(options.e);
                const roomLeft = padding;
                const roomTop = topPadding;
                const roomRight = padding + szoba.x * scale;
                const roomBottom = topPadding + szoba.y * scale;

                // Ellenőrizzük, hogy az egér a szobán belül van-e
                if (pointer.x >= roomLeft && pointer.x <= roomRight && 
                    pointer.y >= roomTop && pointer.y <= roomBottom) {

                    // Ellenőrizzük, hogy az egér valamelyik deszkán van-e
                    let isOverBoard = false;
                    for (const board of boardRects) {
                        if (pointer.x >= board.left && pointer.x <= board.right && 
                            pointer.y >= board.top && pointer.y <= board.bottom) {
                            isOverBoard = true;
                            break;
                        }
                    }

                    // Ha az egér üres területen van, számoljuk ki a távolságokat
                    if (!isOverBoard) {
                        // Távolságok számítása a szoba szélétől a legközelebbi deszkákig

                        // Távolság a legközelebbi deszkától minden irányban - mindig a szoba szélétől mérve
                        let minDistToLeftBoard = Infinity;
                        let minDistToRightBoard = Infinity;
                        let minDistToTopBoard = Infinity;
                        let minDistToBottomBoard = Infinity;

                        // Minden deszkára kiszámoljuk a távolságokat a szoba szélétől
                        for (const board of boardRects) {
                            // Bal szélétől (bal szél és a legbaloldalibb deszka közötti távolság)
                            if (board.left > roomLeft) {
                                const distFromLeftEdge = (board.left - roomLeft) / scale;
                                minDistToLeftBoard = Math.min(minDistToLeftBoard, distFromLeftEdge);
                            }

                            // Jobb szélétől (jobb szél és a legjobboldalibb deszka közötti távolság)
                            if (board.right < roomRight) {
                                const distFromRightEdge = (roomRight - board.right) / scale;
                                minDistToRightBoard = Math.min(minDistToRightBoard, distFromRightEdge);
                            }

                            // Felső szélétől (felső szél és a legfelsőbb deszka közötti távolság)
                            if (board.top > roomTop) {
                                const distFromTopEdge = (board.top - roomTop) / scale;
                                minDistToTopBoard = Math.min(minDistToTopBoard, distFromTopEdge);
                            }

                            // Alsó szélétől (alsó szél és a legalsóbb deszka közötti távolság)
                            if (board.bottom < roomBottom) {
                                const distFromBottomEdge = (roomBottom - board.bottom) / scale;
                                minDistToBottomBoard = Math.min(minDistToBottomBoard, distFromBottomEdge);
                            }
                        }

                        // Tooltip szöveg összeállítása - csak a legkisebb távolságot mutatjuk
                        let tooltipText = 'Üres:\n';

                        // Megkeressük a legkisebb távolságot a négy irány közül
                        let minDistance = Infinity;
                        let minDirection = '';

                        // Bal oldal
                        if (minDistToLeftBoard !== Infinity && minDistToLeftBoard < minDistance) {
                            minDistance = minDistToLeftBoard;
                            minDirection = 'Bal';
                        }

                        // Jobb oldal
                        if (minDistToRightBoard !== Infinity && minDistToRightBoard < minDistance) {
                            minDistance = minDistToRightBoard;
                            minDirection = 'Jobb';
                        }

                        // Felső oldal
                        if (minDistToTopBoard !== Infinity && minDistToTopBoard < minDistance) {
                            minDistance = minDistToTopBoard;
                            minDirection = 'Felső';
                        }

                        // Alsó oldal
                        if (minDistToBottomBoard !== Infinity && minDistToBottomBoard < minDistance) {
                            minDistance = minDistToBottomBoard;
                            minDirection = 'Alsó';
                        }

                        // Csak a legkisebb távolságot jelenítjük meg
                        if (minDirection !== '') {
                            tooltipText += `${minDirection}: ${Math.round(minDistance)} cm`;
                        } else {
                            tooltipText += 'Nincs deszka a közelben';
                        }

                        // Régi tooltip eltávolítása, ha létezik
                        if (distanceTooltip) {
                            canvas.remove(distanceTooltip);
                        }

                        // Új tooltip létrehozása
                        distanceTooltip = new fabric.Text(tooltipText, {
                            left: pointer.x,
                            top: pointer.y - 10,
                            fontSize: 12,
                            fill: 'black',
                            backgroundColor: 'rgba(255,255,255,0.9)',
                            padding: 5,
                            originX: 'center',
                            originY: 'bottom',
                            selectable: false,
                            shadow: new fabric.Shadow({
                                color: 'rgba(0,0,0,0.3)',
                                blur: 5,
                                offsetX: 2,
                                offsetY: 2
                            })
                        });

                        canvas.add(distanceTooltip);
                        distanceTooltip.bringToFront(); // Ensure tooltip is on top
                        canvas.renderAll();
                    } else if (distanceTooltip) {
                        // Ha deszkán van az egér, távolítsuk el a távolság tooltipet
                        canvas.remove(distanceTooltip);
                        distanceTooltip = null;
                        canvas.renderAll();
                    }
                } else if (distanceTooltip) {
                    // Ha a szobán kívül van az egér, távolítsuk el a távolság tooltipet
                    canvas.remove(distanceTooltip);
                    distanceTooltip = null;
                    canvas.renderAll();
                }
            });

            canvas.renderAll();
        }
    </script>
</body>
</html>
