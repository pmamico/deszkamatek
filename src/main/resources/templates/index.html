<!DOCTYPE html>
<html lang="hu" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deszkamatek - Szoba Megjelenítő</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        #canvas-container {
            margin-top: 20px;
            text-align: center;
        }
        canvas {
            border: 1px solid #ddd;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            margin: 0 10px;
        }
        label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100px;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            align-self: flex-end;
        }
        button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Deszkamatek - Szoba Megjelenítő</h1>
        <div style="text-align: center; margin-bottom: 20px;">
            <a href="/raktar" style="color: #4CAF50; text-decoration: none;">Raktár kezelése</a>
        </div>
        <div class="controls">
            <div class="input-group">
                <label for="x-input">Szélesség (X):</label>
                <input type="number" id="x-input" value="460" min="10" max="1000">
            </div>
            <div class="input-group">
                <label for="y-input">Magasság (Y):</label>
                <input type="number" id="y-input" value="397" min="10" max="1000">
            </div>
            <button id="calculate-btn">Újraszámolás</button>
        </div>
        <div id="canvas-container">
            <canvas id="szoba-canvas" width="800" height="600"></canvas>
        </div>
    </div>

    <!-- Fabric.js könyvtár betöltése CDN-ről -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

    <script>
        // Fabric.js canvas inicializálása
        const canvas = new fabric.Canvas('szoba-canvas');

        // Oldalállapot jelölő létrehozása
        function createSideMarker(x, y, side, allapot) {
            let marker;
            const size = 15;
            let color;
            let text;

            // Állapot szerinti színezés és szöveg
            const allapotStr = typeof allapot === 'string' ? allapot : allapot.toString();

            if (allapotStr.includes('CSAP')) {
                color = 'blue';
                text = 'C';
            } else if (allapotStr.includes('NUT')) {
                color = 'green';
                text = 'N';
            } else if (allapotStr.includes('VAGOTT')) {
                color = 'red';
                text = 'V';
            } else {
                color = 'gray';
                text = '?';
            }

            // Oldal szerinti pozícionálás
            let left = x;
            let top = y;
            let originX = 'center';
            let originY = 'center';

            switch(side) {
                case 'left':
                    left -= size/2;
                    originX = 'right';
                    break;
                case 'right':
                    left += size/2;
                    originX = 'left';
                    break;
                case 'top':
                    top -= size/2;
                    originY = 'bottom';
                    break;
                case 'bottom':
                    top += size/2;
                    originY = 'top';
                    break;
            }

            // Marker létrehozása (kör alakú háttér szöveggel)
            const circle = new fabric.Circle({
                left: left,
                top: top,
                radius: size/2,
                fill: color,
                stroke: 'black',
                strokeWidth: 1,
                originX: originX,
                originY: originY
            });

            const label = new fabric.Text(text, {
                left: left,
                top: top,
                fontSize: 10,
                fill: 'white',
                fontWeight: 'bold',
                originX: originX,
                originY: originY
            });

            // Csoportba foglalás
            marker = new fabric.Group([circle, label], {
                left: left,
                top: top,
                originX: originX,
                originY: originY,
                selectable: false
            });

            return marker;
        }

        // Kezdeti szoba adatok lekérése a szerverről
        fetchSzobaData();

        // Újraszámolás gomb eseménykezelő
        document.getElementById('calculate-btn').addEventListener('click', function() {
            fetchSzobaData();
        });

        // Szoba adatok lekérése a szerverről
        function fetchSzobaData() {
            const xInput = document.getElementById('x-input');
            const yInput = document.getElementById('y-input');

            const x = xInput.value;
            const y = yInput.value;

            // Tisztítjuk a canvas-t új adatok betöltése előtt
            canvas.clear();

            fetch(`/api/epito?x=${x}&y=${y}`)
                .then(response => response.json())
                .then(data => {
                    renderSzoba(data);
                })
                .catch(error => console.error('Hiba történt:', error));
        }

        // Szoba és deszkák megjelenítése
        function renderSzoba(data) {
            const szoba = data.szoba;
            const lerakottDeszkak = data.lerakottDeszkak;

            // Canvas méretezése a szoba méretéhez
            const canvasWidth = 800;
            const canvasHeight = 600;
            const padding = 50;

            // Skálázási faktor kiszámítása, hogy a szoba elférjen a canvas-en
            const scaleX = (canvasWidth - 2 * padding) / szoba.x;
            const scaleY = (canvasHeight - 2 * padding) / szoba.y;
            const scale = Math.min(scaleX, scaleY);

            // Szoba háttér (halványszürke téglalap)
            const szobaRect = new fabric.Rect({
                left: padding,
                top: padding,
                width: szoba.x * scale,
                height: szoba.y * scale,
                fill: '#e0e0e0',
                stroke: '#999',
                strokeWidth: 1,
                selectable: false
            });
            canvas.add(szobaRect);

            // X tengely hosszának megjelenítése
            const xAxisLabel = new fabric.Text(
                `X tengely: ${szoba.x} cm`, 
                {
                    left: padding + (szoba.x * scale) / 2,
                    top: padding + szoba.y * scale + 20,
                    fontSize: 14,
                    fill: 'black',
                    originX: 'center',
                    selectable: false
                }
            );
            canvas.add(xAxisLabel);

            // Y tengely hosszának megjelenítése
            const yAxisLabel = new fabric.Text(
                `Y tengely: ${szoba.y} cm`, 
                {
                    left: padding - 20,
                    top: padding + (szoba.y * scale) / 2,
                    fontSize: 14,
                    fill: 'black',
                    originY: 'center',
                    angle: -90,
                    selectable: false
                }
            );
            canvas.add(yAxisLabel);

            // Deszkák kirajzolása
            lerakottDeszkak.forEach(deszka => {
                const x = deszka.poz.x * scale + padding;
                const y = padding + (szoba.y - deszka.poz.y) * scale;
                const width = deszka.deszka.szelesseg * scale;
                const height = deszka.deszka.hosszusag * scale;

                const deszkaRect = new fabric.Rect({
                    left: x,
                    top: y,
                    width: width,
                    height: height,
                    fill: '#8B4513',  // Barna szín a deszkáknak
                    stroke: '#5D2906',
                    strokeWidth: 1,
                    selectable: false,
                    opacity: 0.8
                });

                canvas.add(deszkaRect);

                // Deszka információk hozzáadása tooltip-ként
                deszkaRect.on('mouseover', function() {
                    this.set('opacity', 1);

                    // Tooltip létrehozása a deszka méreteihez és oldalállapotaihoz
                    const tooltip = new fabric.Text(
                        `Szélesség: ${deszka.deszka.szelesseg} cm\nHosszúság: ${deszka.deszka.hosszusag} cm`, 
                        {
                            left: x + width / 2,
                            top: y - 30,
                            fontSize: 14,
                            fill: 'black',
                            backgroundColor: 'rgba(255,255,255,0.8)',
                            padding: 5,
                            originX: 'center',
                            originY: 'bottom'
                        }
                    );

                    // Oldalállapotok jelölése
                    const sideMarkers = [];

                    // Bal oldal (CSAP/NUT/VAGOTT)
                    if (deszka.deszka.balOldal) {
                        const balMarker = createSideMarker(x, y + height/2, 'left', deszka.deszka.balOldal);
                        sideMarkers.push(balMarker);
                    }

                    // Felső oldal (CSAP/NUT/VAGOTT)
                    if (deszka.deszka.felsoOldal) {
                        const felsoMarker = createSideMarker(x + width/2, y, 'top', deszka.deszka.felsoOldal);
                        sideMarkers.push(felsoMarker);
                    }

                    // Jobb oldal (CSAP/NUT/VAGOTT)
                    if (deszka.deszka.jobbOldal) {
                        const jobbMarker = createSideMarker(x + width, y + height/2, 'right', deszka.deszka.jobbOldal);
                        sideMarkers.push(jobbMarker);
                    }

                    // Alsó oldal (CSAP/NUT/VAGOTT)
                    if (deszka.deszka.alsoOldal) {
                        const alsoMarker = createSideMarker(x + width/2, y + height, 'bottom', deszka.deszka.alsoOldal);
                        sideMarkers.push(alsoMarker);
                    }

                    // Tooltip és jelölők hozzáadása a canvas-hez
                    canvas.add(tooltip);
                    sideMarkers.forEach(marker => canvas.add(marker));

                    // Tooltip és jelölők tárolása a deszkaRect objektumban
                    this.tooltip = tooltip;
                    this.sideMarkers = sideMarkers;

                    canvas.renderAll();
                });

                deszkaRect.on('mouseout', function() {
                    this.set('opacity', 0.8);

                    // Tooltip és jelölők eltávolítása
                    if (this.tooltip) {
                        canvas.remove(this.tooltip);
                        this.tooltip = null;
                    }

                    if (this.sideMarkers) {
                        this.sideMarkers.forEach(marker => canvas.remove(marker));
                        this.sideMarkers = [];
                    }

                    canvas.renderAll();
                });
            });

            canvas.renderAll();
        }
    </script>
</body>
</html>
